# Complete Infrastructure Structure

This document shows the complete directory structure of the production-grade infrastructure.

## üìÇ Full Directory Tree

```
infra-demo/
‚îÇ
‚îú‚îÄ‚îÄ README.md                          # Main documentation
‚îú‚îÄ‚îÄ QUICK_START.md                     # Quick start guide
‚îú‚îÄ‚îÄ COMMANDS.md                        # Command reference
‚îú‚îÄ‚îÄ .gitignore                         # Git ignore patterns
‚îÇ
‚îú‚îÄ‚îÄ docs/                              # Additional documentation
‚îÇ   ‚îú‚îÄ‚îÄ BEST_PRACTICES.md             # Production best practices
‚îÇ   ‚îî‚îÄ‚îÄ TROUBLESHOOTING.md            # Troubleshooting guide
‚îÇ
‚îú‚îÄ‚îÄ terraform/                         # Terraform infrastructure
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ modules/                      # Reusable modules
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ networking/               # VPC, subnets, routing
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf              # VPC, IGW, NAT, subnets
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf         # Input variables
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ outputs.tf           # Module outputs
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ compute/                  # EC2, ASG, launch templates
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf              # Instances, ASG, IAM
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf         # Input variables
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf           # Module outputs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ user_data.sh     # Instance initialization
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security/                 # Security groups, NACLs
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ main.tf              # Security configurations
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ variables.tf         # Input variables
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ outputs.tf           # Module outputs
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ environments/                 # Environment-specific configs
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dev/                     # Development
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf              # Dev infrastructure
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf         # Dev variables
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf           # Dev outputs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars.example  # Example config
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ terraform.tfvars     # Actual config (gitignored)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ staging/                 # Staging
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf              # Staging infrastructure
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf         # Staging variables
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf           # Staging outputs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars.example
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ terraform.tfvars     # (gitignored)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ production/              # Production
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ main.tf              # Production infrastructure
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ variables.tf         # Production variables
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ outputs.tf           # Production outputs
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ terraform.tfvars.example
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ terraform.tfvars     # (gitignored)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ templates/                    # Template files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inventory.tpl            # Ansible inventory template
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ group_vars.tpl           # Ansible variables template
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ scripts/                      # Helper scripts
‚îÇ       ‚îú‚îÄ‚îÄ setup-backend.sh         # S3 backend setup
‚îÇ       ‚îú‚îÄ‚îÄ destroy-backend.sh       # Backend cleanup
‚îÇ       ‚îú‚îÄ‚îÄ deploy.sh                # Environment deployment
‚îÇ       ‚îî‚îÄ‚îÄ destroy.sh               # Environment destruction
‚îÇ
‚îî‚îÄ‚îÄ ansible/                          # Ansible configuration
    ‚îÇ
    ‚îú‚îÄ‚îÄ ansible.cfg                   # Ansible settings
    ‚îú‚îÄ‚îÄ playbook.yml                  # Main deployment playbook
    ‚îú‚îÄ‚îÄ verify.yml                    # Verification playbook
    ‚îú‚îÄ‚îÄ README.md                     # Ansible documentation
    ‚îÇ
    ‚îú‚îÄ‚îÄ group_vars/                   # Global variables
    ‚îÇ   ‚îî‚îÄ‚îÄ all.yml                   # (auto-generated by Terraform)
    ‚îÇ
    ‚îú‚îÄ‚îÄ inventory/                    # Environment inventories
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ dev/                     # Dev inventory
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hosts                # (auto-generated)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ group_vars/
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ all.yml          # (auto-generated)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ staging/                 # Staging inventory
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hosts                # (auto-generated)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ group_vars/
    ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ all.yml          # (auto-generated)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ production/              # Production inventory
    ‚îÇ       ‚îú‚îÄ‚îÄ hosts                # (auto-generated)
    ‚îÇ       ‚îî‚îÄ‚îÄ group_vars/
    ‚îÇ           ‚îî‚îÄ‚îÄ all.yml          # (auto-generated)
    ‚îÇ
    ‚îî‚îÄ‚îÄ templates/                    # Jinja2 templates
        ‚îú‚îÄ‚îÄ app.service.j2           # Systemd service template
        ‚îî‚îÄ‚îÄ nginx.conf.j2            # Nginx config template
```

## üîë Key Files Explained

### Terraform Modules

#### `terraform/modules/networking/main.tf`
- Creates VPC with DNS support
- Public subnets across multiple AZs
- Private subnets (optional, for production)
- Internet Gateway for public internet access
- NAT Gateways for private subnet internet (optional)
- Route tables and associations
- VPC Flow Logs (optional, for security)
- CloudWatch Log Groups for flow logs

#### `terraform/modules/compute/main.tf`
- Latest Ubuntu AMI lookup
- SSH key pair creation
- IAM role for EC2 instances (SSM, CloudWatch)
- IAM instance profile
- Launch template with:
  - Encrypted EBS volumes
  - IMDSv2 requirement
  - User data for initialization
  - CloudWatch agent setup
- EC2 instances OR Auto Scaling Group
- Auto Scaling policies (CPU-based)
- CloudWatch alarms for scaling

#### `terraform/modules/security/main.tf`
- Application Load Balancer security group (optional)
- Application security group
  - HTTP (80)
  - Application port (3000)
  - SSH (22, configurable)
- Database security group (optional)
- Network ACLs (optional, additional security layer)
- All with proper ingress/egress rules

### Environment Configurations

#### `terraform/environments/dev/main.tf`
**Development Focus**: Fast iteration, cost optimization
- Single NAT gateway (if enabled)
- No VPC Flow Logs
- t3.micro instances
- No Auto Scaling
- SSH enabled for debugging
- Basic monitoring

#### `terraform/environments/staging/main.tf`
**Staging Focus**: Production-like testing
- NAT gateway enabled
- VPC Flow Logs enabled
- t3.small instances
- Optional Auto Scaling
- Network ACLs
- Enhanced monitoring

#### `terraform/environments/production/main.tf`
**Production Focus**: High availability, security, compliance
- Multi-AZ NAT gateways
- VPC Flow Logs with 30-day retention
- t3.medium instances
- Auto Scaling enabled (2-10 instances)
- CloudWatch alarms & SNS alerts
- SSH disabled (SSM only)
- Private subnets for compute
- ALB security group

### Ansible Playbooks

#### `ansible/playbook.yml`
Main deployment playbook:
1. Update system packages
2. Install system dependencies
3. Install Node.js (specific version)
4. Create application user
5. Create application directory
6. Copy application files
7. Install npm dependencies
8. Create systemd service
9. Start application service
10. Configure Nginx reverse proxy
11. Configure UFW firewall
12. Wait for application health check

#### `ansible/verify.yml`
Verification playbook:
1. Check systemd service status
2. Test application health endpoint
3. Check Nginx status
4. Test Nginx proxy to application
5. Display results

### Templates

#### `terraform/templates/inventory.tpl`
Jinja2 template that generates Ansible inventory:
- Lists all instances with IPs
- Sets connection parameters
- Includes environment variable

#### `terraform/templates/group_vars.tpl`
Jinja2 template for Ansible variables:
- Application configuration
- Node.js version
- Environment settings
- Performance tuning based on environment

#### `ansible/templates/app.service.j2`
Systemd service template:
- Runs as dedicated user
- Auto-restart on failure
- Environment variables
- Logging to journald

#### `ansible/templates/nginx.conf.j2`
Nginx reverse proxy configuration:
- Listens on port 80
- Proxies to application port
- Health check endpoint
- Proper headers

## üéØ Component Interactions

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Developer                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îú‚îÄ‚îÄ> terraform init/plan/apply
                ‚îÇ    ‚îî‚îÄ‚îÄ> S3 Backend (remote state)
                ‚îÇ         ‚îî‚îÄ‚îÄ> DynamoDB (state locking)
                ‚îÇ
                ‚îú‚îÄ‚îÄ> Creates AWS Resources
                ‚îÇ    ‚îú‚îÄ‚îÄ> VPC (networking module)
                ‚îÇ    ‚îú‚îÄ‚îÄ> EC2/ASG (compute module)
                ‚îÇ    ‚îî‚îÄ‚îÄ> Security Groups (security module)
                ‚îÇ
                ‚îú‚îÄ‚îÄ> Generates Files
                ‚îÇ    ‚îú‚îÄ‚îÄ> ansible/inventory/{env}/hosts
                ‚îÇ    ‚îî‚îÄ‚îÄ> ansible/inventory/{env}/group_vars/all.yml
                ‚îÇ
                ‚îî‚îÄ‚îÄ> ansible-playbook
                     ‚îú‚îÄ‚îÄ> Reads generated inventory
                     ‚îú‚îÄ‚îÄ> Connects to instances via SSH
                     ‚îú‚îÄ‚îÄ> Installs Node.js
                     ‚îú‚îÄ‚îÄ> Deploys application
                     ‚îú‚îÄ‚îÄ> Configures Nginx
                     ‚îî‚îÄ‚îÄ> Sets up systemd service
                          ‚îî‚îÄ‚îÄ> Application Running ‚úì
```

## üìä Resource Count by Environment

### Development
- 1 VPC
- 2 Public Subnets
- 1 Internet Gateway
- 1 Route Table
- 2 Security Groups
- 1 EC2 Instance (t3.micro)
- 1 IAM Role + Instance Profile
- **Total**: ~9 resources
- **Cost**: ~$10-15/month

### Staging
- 1 VPC
- 2 Public Subnets
- 2 Private Subnets
- 1 Internet Gateway
- 1 NAT Gateway
- 3 Route Tables
- 3 Security Groups
- 2 EC2 Instances (t3.small) OR ASG
- 1 IAM Role + Instance Profile
- VPC Flow Logs + CloudWatch Log Group
- **Total**: ~20-25 resources
- **Cost**: ~$50-75/month

### Production
- 1 VPC
- 3 Public Subnets
- 3 Private Subnets
- 1 Internet Gateway
- 3 NAT Gateways (Multi-AZ)
- 5 Route Tables
- 4 Security Groups (App, ALB, DB)
- Auto Scaling Group (2-10 instances, t3.medium)
- Launch Template
- 2 IAM Roles (EC2, Flow Logs)
- VPC Flow Logs + CloudWatch
- CloudWatch Alarms (CPU, Health)
- SNS Topic for alerts
- **Total**: ~40-50+ resources
- **Cost**: ~$200-500/month

## üîÑ Workflow

### Initial Setup
1. Run `setup-backend.sh` (once)
2. Edit `terraform.tfvars` per environment
3. `terraform init` in environment folder
4. `terraform apply` to create infrastructure
5. `ansible-playbook` to deploy application

### Updates

**Infrastructure changes**:
```bash
cd terraform/environments/<env>
terraform plan  # Review
terraform apply
```

**Application changes**:
```bash
cd ansible
ansible-playbook -i inventory/<env>/hosts playbook.yml
```

### Teardown
```bash
cd terraform/environments/<env>
terraform destroy
```

## üîê Security Layers

1. **Network**: VPC isolation, private subnets
2. **Firewall**: Security groups + Network ACLs
3. **Access**: SSH keys, IAM roles, SSM
4. **Encryption**: EBS volumes, S3 state
5. **Monitoring**: VPC Flow Logs, CloudWatch
6. **Compliance**: Resource tagging, audit logs

## üìà Scalability Features

- **Horizontal**: Auto Scaling Groups
- **Vertical**: Instance type variables
- **Geographic**: Multi-AZ deployment
- **Performance**: Launch template optimization
- **Cost**: Environment-specific sizing

---

**This structure follows AWS Well-Architected Framework principles and DevOps best practices!**